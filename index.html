<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Revive Lookup</title>
  <style>
    :root{
      /* Brand knobs: tweak these 5 */
      --bg:#0b1220;            /* page background */
      --card:#101a2b;          /* cards */
      --ink:#e6eefc;           /* main text */
      --ink-dim:#a6b4cc;       /* muted text */
      --accent:#22d3a3;        /* emerald/teal accent */
      --accent-2:#6ea8fe;      /* secondary (links) */
      --danger:#ff6b6b;        /* red */
      --ok:#4ade80;            /* green */
      --warn:#facc15;          /* amber */
      --border:#1e2a40;        /* borders */
      --ring:#29c6ff;          /* focus ring */
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --glass: rgba(255,255,255,.04);
    }
    *{box-sizing:border-box}
    body{
      margin:0; color:var(--ink);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 600px at 80% -10%, rgba(34,211,163,.12), transparent 60%),
        radial-gradient(1000px 500px at -10% 10%, rgba(110,168,254,.10), transparent 60%),
        var(--bg);
    }
    header{
      position:sticky; top:0; z-index:40; display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px; backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(16,26,43,.85), rgba(11,18,32,.85));
      border-bottom:1px solid var(--border);
    }
    header h1{margin:0; font-size:18px; letter-spacing:.4px}
    .badge{font-size:12px; padding:6px 10px; border-radius:999px; background:var(--glass); color:var(--accent); border:1px solid rgba(34,211,163,.35)}
    .container{display:grid; grid-template-columns:320px 1fr 360px; gap:16px; padding:16px}
    .card{background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)), var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; box-shadow: var(--shadow)}
    .section-title{font-size:11px; text-transform:uppercase; letter-spacing:.14em; color:var(--ink-dim); margin:0 0 10px}
    input, select, button, textarea{background:#0c1424; border:1px solid var(--border); color:var(--ink); border-radius:12px; padding:10px 12px; outline:none; transition:border-color .15s, box-shadow .15s, transform .05s}
    input:focus, select:focus, textarea:focus{border-color:var(--ring); box-shadow:0 0 0 3px rgba(41,198,255,.15)}
    button{background:linear-gradient(180deg,#182237,#121a2c); cursor:pointer}
    button:hover{transform:translateY(-1px)}
    button:active{transform:translateY(0)}
    button.primary{background:linear-gradient(180deg,#1f7f67,#145b4f); border-color:#20836c; box-shadow: 0 6px 20px rgba(34,211,163,.18)}
    button.warn{background:linear-gradient(180deg,#7a4600,#4a2b00); border-color:#7a4600}
    button.ghost{background:transparent; border-color:#2a374d}
    .ghostlink{background:none; border:none; color:var(--accent-2); padding:0; cursor:pointer}
    .list{display:flex; flex-direction:column; gap:10px; max-height:60vh; overflow:auto; padding-right:4px}
    .list > div{background:#0c1424; border:1px solid var(--border); border-radius:14px; padding:10px 12px; transition: border-color .15s, transform .05s}
    .list > div:hover{border-color:#2b3b5a; transform:translateY(-1px)}
    .table{width:100%; border-collapse:separate; border-spacing:0 10px}
    .table thead th{font-size:12px; color:var(--ink-dim); text-align:left; font-weight:600; padding:2px 8px}
    .table tbody td{padding:12px 10px; background:#0c1424; border:1px solid var(--border); border-top-left-radius:12px; border-bottom-left-radius:12px}
    .tr{display:grid; grid-template-columns: 1.2fr 80px 100px 110px 1.1fr 110px 34px; gap:10px; align-items:center}
    .qty{width:76px}
    .offer{display:flex; gap:8px; align-items:center}
    .offer input[type=number]{width:110px}
    input[type=range]{width:100%; height:32px; background:transparent}
    input[type=range]::-webkit-slider-runnable-track{height:6px; border-radius:999px; background:linear-gradient(90deg, var(--accent), rgba(255,255,255,.2))}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none; width:18px; height:18px; border-radius:999px; background:white; border:3px solid var(--accent); margin-top:-6px; box-shadow:0 2px 10px rgba(0,0,0,.45)}
    .redline{outline:2px solid var(--danger)}
    .totals{display:grid; grid-template-columns:1fr 220px; gap:14px; align-items:start}
    .totals .box{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)), #0c1424; border:1px solid var(--border); border-radius:16px; padding:14px}
    .tot-line{display:flex; justify-content:space-between; margin:6px 0}
    .tot-line strong{font-size:18px}
    .row{display:flex; gap:10px; align-items:center}
    .col{display:flex; flex-direction:column; gap:10px}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid #2d3c53; font-size:12px; color:var(--ink-dim)}
    .muted{color:var(--ink-dim)} .tag{font-size:11px; color:var(--ink-dim)}
    .right{display:flex; flex-direction:column; gap:12px}
    .quote-list{max-height:44vh; overflow:auto}
    .badge-red{background:rgba(255,93,93,.12); color:var(--danger); border:1px solid rgba(255,93,93,.4)}
    .patient-view .manager-only{display:none!important} .patient-view .muted{color:#c4d0e6}
    @media print{header, .container > .card.left, .right, .manager-only{display:none!important} body{background:white; color:black} .card{border:none; box-shadow:none} .patient-view .table tbody td{background:white; border:1px solid #ccc}}
  </style>
</head>
<body>
  <header>
    <h1>Revive Lookup</h1>
    <div class="row" style="gap:10px">
      <span id="catalogStatus" class="badge">Catalog: Sample</span>
      <button id="toggleViewBtn" class="ghost">Switch to Patient View</button>
      <button id="printBtn" class="ghost">Print / Save PDF</button>
    </div>
  </header>

  <div class="container">
    <div class="card left">
      <p class="section-title">Catalog</p>
      <div class="col">
        <div class="row">
          <input id="search" placeholder="Search procedures (e.g., Hydrafacial, PRP)" />
          <button id="clearSearch">Clear</button>
        </div>
        <div class="list" id="results"></div>
        <div class="col">
          <p class="section-title">Import Catalog (CSV or JSON)</p>
          <input type="file" id="fileInput" accept=".csv,.json" />
          <div class="row">
            <button id="loadFile" class="primary">Load File</button>
            <button id="downloadTemplate" class="ghost">CSV Template</button>
          </div>
          <p class="muted" style="font-size:12px">Columns: <em>id?, name, category, original, advertised, floor, aliases, bundle_type, bundle_min_qty, bundle_unit_price, bundle_total_price</em></p>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between; align-items:center">
        <p class="section-title">Plan Builder</p>
        <div class="row manager-only">
          <span class="pill">Floor = minimum allowed</span>
          <span class="pill">Red = at/below floor</span>
        </div>
      </div>
      <table class="table">
        <thead class="grid-head">
          <tr class="grid-head">
            <th>Procedure</th><th>Qty</th><th>Original</th><th>Advertised</th><th>Your Offer</th><th class="manager-only">Floor</th><th></th>
          </tr>
        </thead>
        <tbody id="planBody"></tbody>
      </table>
      <div class="totals">
        <div class="box">
          <div class="tot-line"><span class="muted">Original total</span><strong id="origTotal">—</strong></div>
          <div class="tot-line"><span class="muted">Advertised baseline</span><strong id="advTotal">—</strong></div>
          <div class="tot-line"><span>Patient pays</span><strong id="offerTotal">—</strong></div>
          <div class="tot-line"><span class="ok">Savings vs original</span><strong id="savings">—</strong></div>
        </div>
        <div class="box">
          <div class="row"><input id="patientName" placeholder="Patient name (optional)" /><input id="quoteLabel" placeholder="Quote label (e.g., ‘Hydra + PRP’)" /></div>
          <div class="row" style="margin-top:8px"><button id="saveQuote" class="primary">Save Quote</button><button id="clearPlan" class="warn">Clear Plan</button></div>
        </div>
      </div>
    </div>

    <div class="card right">
      <p class="section-title">Saved Quotes</p>
      <div id="quotes" class="quote-list"></div>
      <div class="spacer"></div>
      <p class="section-title">Settings</p>
      <div class="kv"><span>Data backend</span><span id="backendLabel">Local</span></div>
      <div class="col" style="gap:6px">
        <input id="supabaseUrl" placeholder="Supabase URL" />
        <input id="supabaseKey" placeholder="Supabase anon key" />
        <div class="row"><button id="connectSupabase" class="primary">Connect</button><button id="disconnectSupabase" class="ghost">Disconnect</button></div>
        <div class="row"><button id="syncCatalogUp" class="ghost">Upload Catalog → Supabase</button><button id="syncCatalogDown" class="ghost">Load Catalog ← Supabase</button></div>
      </div>
    </div>
  </div>

  <script type="module">
  // ----- Utilities -----
  const $ = (s)=>document.querySelector(s);
  const currency=(n)=> (n==null||isNaN(n)) ? '—' : new Intl.NumberFormat('en-PK',{style:'currency',currency:'PKR',maximumFractionDigits:0}).format(n);
  const parseNumber=(str)=> Number(String(str).replace(/[^\d.]/g,''))||0;

  // ----- State -----
  let catalog=[]; let plan=[]; const quotesKey='revive_quotes_v2';
  let supa=null; let supaEnabled=false;

  // ----- Sample data (remove later) -----
  const sampleCatalog=[
    {id:'prp', name:'PRP (Platelet-Rich Plasma)', category:'Skin', original:10000, advertised:7000, floor:5000, aliases:['PRP'], bundles:[{type:'total_price_for_min_qty',min_qty:3,total_price:21000}]},
    {id:'pdrn_micro', name:'PDRN Microneedling', category:'Skin', original:15000, advertised:12000, floor:9000, aliases:['PDRN','Microneedling PDRN'], bundles:[]},
    {id:'hydra', name:'Hydrafacial', category:'Facial', original:10000, advertised:7000, floor:5000, aliases:['Hydra','Hydra Facial'], bundles:[]},
    {id:'meso_gluta', name:'Meso Gluta', category:'Skin', original:12000, advertised:10000, floor:8000, aliases:['Glutathione Meso'], bundles:[{type:'unit_price_for_min_qty',min_qty:3,unit_price:9000}]}
  ];

  function loadSample(){ catalog = sampleCatalog; $('#catalogStatus').textContent='Catalog: Sample'; renderResults(); }

  // ----- Supabase -----
  async function ensureSupabase(){
    if(supa) return supa;
    const { createClient } = await import('https://esm.sh/@supabase/supabase-js@2');
    const url = localStorage.getItem('revive_supa_url');
    const key = localStorage.getItem('revive_supa_key');
    if(!url || !key) throw new Error('Missing Supabase URL/key in Settings');
    supa = createClient(url, key); return supa;
  }

  async function supaLoadCatalog(){
    const sb = await ensureSupabase();
    const { data, error } = await sb.from('catalog').select('*').order('name');
    if(error) throw error; 
    const items = (data||[]).map(row=>({
      id: row.id,
      name: row.name,
      category: row.category||'General',
      original: Number(row.original)||0,
      advertised: row.advertised==null? null : Number(row.advertised),
      floor: Number(row.floor)||0,
      aliases: Array.isArray(row.aliases)? row.aliases : String(row.aliases||'').split('|').map(s=>s.trim()).filter(Boolean),
      bundles: Array.isArray(row.bundles)? row.bundles : (row.bundles? JSON.parse(row.bundles):[])
    }));
    catalog = items; $('#catalogStatus').textContent='Catalog: Supabase'; renderResults();
  }

  async function supaUploadCatalog(){
    if(!Array.isArray(catalog) || catalog.length===0){ alert('No catalog in memory. Import CSV or load sample first.'); return; }
    const sb = await ensureSupabase();
    const payload = catalog.map(it=>({ id:it.id, name:it.name, category:it.category, original:it.original, advertised:it.advertised, floor:it.floor, aliases:it.aliases, bundles:it.bundles }));
    const { error } = await sb.from('catalog').upsert(payload);
    if(error) throw error; alert('Catalog uploaded to Supabase.');
  }

  // ----- Search & results -----
  function renderResults(){
    const q = ($('#search').value||'').toLowerCase().trim();
    const results = catalog.filter(it => !q || it.name.toLowerCase().includes(q) || (it.aliases||[]).some(a=>a.toLowerCase().includes(q)) || (it.category||'').toLowerCase().includes(q));
    const list=$('#results'); list.innerHTML='';
    results.slice(0,200).forEach(it=>{
      const row=document.createElement('div'); row.className='row'; row.style.justifyContent='space-between';
      row.innerHTML=`<div class="col" style="gap:2px"><div><strong>${it.name}</strong></div><div class="muted" style="font-size:12px">Orig ${currency(it.original)}${it.advertised?` • Adv ${currency(it.advertised)}`:''} • Floor ${currency(it.floor)}</div></div><button data-id="${it.id}">Add</button>`;
      row.querySelector('button').addEventListener('click',()=>addToPlan(it.id)); list.appendChild(row);
    });
  }

  function findItem(id){ return catalog.find(x=>x.id===id); }

  function addToPlan(id){
    const existing = plan.find(p=>p.id===id);
    if(existing){ existing.qty += 1; }
    else { const item=findItem(id); const defaultOffer=(item.advertised??item.original); plan.push({id, qty:1, offerUnit:defaultOffer}); }
    applyBundles(); renderPlan();
  }

  function removeFromPlan(id){ plan = plan.filter(p=>p.id!==id); renderPlan(); calcTotals(); }

  function applyBundles(){
    plan.forEach(line=>{
      const item=findItem(line.id); if(!item||!item.bundles||item.bundles.length===0) return;
      item.bundles.forEach(rule=>{
        if(line.qty>=rule.min_qty){
          if(rule.type==='unit_price_for_min_qty' && rule.unit_price!=null){ if(line.offerUnit>rule.unit_price) line.offerUnit=rule.unit_price; }
          if(rule.type==='total_price_for_min_qty' && rule.total_price!=null){ const unit=Math.round(rule.total_price/rule.min_qty); if(line.offerUnit>unit) line.offerUnit=unit; }
        }
      });
    });
  }

  function renderPlan(){
    const tbody=$('#planBody'); tbody.innerHTML='';
    plan.forEach(line=>{
      const item=findItem(line.id); if(!item) return; const adv=item.advertised??null; const floor=item.floor??0;
      const tr=document.createElement('tr'); tr.className='tr';
      tr.innerHTML=`
        <td><div><strong>${item.name}</strong></div><div class="tag">${item.category||'—'}</div></td>
        <td><input class="qty" type="number" min="1" step="1" value="${line.qty}"></td>
        <td>${currency(item.original)}</td>
        <td>${adv?currency(adv):'<span class="muted">—</span>'}</td>
        <td>
          <div class="offer">
            <input class="price" type="range" min="${floor}" max="${item.original}" step="100" value="${line.offerUnit}">
            <input class="unit" type="number" step="100" value="${line.offerUnit}">
          </div>
        </td>
        <td class="manager-only">${currency(floor)}</td>
        <td><button class="ghost" title="Remove">✕</button></td>`;
      const qtyInput=tr.querySelector('.qty'); const range=tr.querySelector('input[type=range]'); const unitInput=tr.querySelector('.unit'); const removeBtn=tr.querySelector('button');
      function syncColor(){ const offer=Number(unitInput.value||0); if(offer<=floor){ unitInput.classList.add('redline'); range.style.accentColor=getComputedStyle(document.documentElement).getPropertyValue('--danger'); } else { unitInput.classList.remove('redline'); range.style.accentColor=getComputedStyle(document.documentElement).getPropertyValue('--accent'); } }
      qtyInput.addEventListener('change',()=>{ line.qty=Math.max(1,parseInt(qtyInput.value||1)); applyBundles(); calcTotals(); renderPlan(); });
      range.addEventListener('input',()=>{ unitInput.value=range.value; line.offerUnit=Number(range.value); syncColor(); calcTotals(); });
      unitInput.addEventListener('input',()=>{ let v=Number(unitInput.value||0); if(isNaN(v)) v=item.original; v=Math.max(0,v); unitInput.value=v; range.value=v; line.offerUnit=v; syncColor(); calcTotals(); });
      removeBtn.addEventListener('click',()=>removeFromPlan(line.id));
      syncColor(); tbody.appendChild(tr);
    });
    calcTotals();
  }

  function calcTotals(){
    let orig=0, adv=0, offer=0; plan.forEach(line=>{ const item=findItem(line.id); if(!item) return; orig+=(item.original||0)*line.qty; const advUnit=(item.advertised??item.original)||0; adv+=advUnit*line.qty; offer+=(line.offerUnit||0)*line.qty; });
    $('#origTotal').textContent=currency(orig); $('#advTotal').textContent=currency(adv); $('#offerTotal').textContent=currency(offer); $('#savings').textContent=currency(Math.max(0,orig-offer));
  }

  // ----- Quotes (local or Supabase) -----
  function getQuotesLocal(){ try{return JSON.parse(localStorage.getItem(quotesKey)||'[]');}catch(e){return []} }
  function setQuotesLocal(arr){ localStorage.setItem(quotesKey, JSON.stringify(arr)); }

  async function saveQuote(){
    if(plan.length===0){ alert('Add at least one item to save a quote.'); return; }
    const id='q_'+Math.random().toString(36).slice(2,9);
    const items=plan.map(l=>({id:l.id, name:findItem(l.id)?.name||l.id, qty:l.qty, offerUnit:l.offerUnit}));
    const totals={ orig:parseNumber($('#origTotal').textContent), adv:parseNumber($('#advTotal').textContent), offer:parseNumber($('#offerTotal').textContent) };
    const q={ id, ts:Date.now(), label:$('#quoteLabel').value.trim(), patient:$('#patientName').value.trim(), items, totals };
    if(supaEnabled){ const sb=await ensureSupabase(); const { error } = await sb.from('quotes').upsert(q); if(error){ alert('Supabase save failed, saving locally. '+error.message); const old=getQuotesLocal(); old.push(q); setQuotesLocal(old); } }
    else { const old=getQuotesLocal(); old.push(q); setQuotesLocal(old); }
    await renderQuotes(); alert('Quote saved.');
  }

  async function renderQuotes(){
    const list=$('#quotes'); list.innerHTML=''; let qs=[];
    if(supaEnabled){ const sb=await ensureSupabase(); const { data, error } = await sb.from('quotes').select('*').order('ts',{ascending:false}).limit(100); if(error){ console.warn(error); qs=getQuotesLocal(); } else { qs=data||[]; } $('#backendLabel').textContent='Supabase'; }
    else { qs=getQuotesLocal().slice().reverse(); $('#backendLabel').textContent='Local'; }
    if(qs.length===0){ list.innerHTML='<div class="muted" style="font-size:12px">No saved quotes yet.</div>'; return; }
    qs.forEach(q=>{ const box=document.createElement('div'); box.style.border='1px solid var(--border)'; box.style.borderRadius='12px'; box.style.padding='10px'; box.style.marginBottom='8px'; const items=(q.items||[]).map(it=>`${it.name} ×${it.qty} @ ${currency(it.offerUnit)} = ${currency(it.offerUnit*it.qty)}`).join('<br>'); box.innerHTML=`<div style="display:flex; justify-content:space-between; gap:8px; align-items:center"><div><strong>${q.label||'Unnamed Quote'}</strong><div class="muted" style="font-size:12px">${q.patient||'Patient N/A'} • ${new Date(q.ts).toLocaleString()}</div></div><div class="small">Total: <strong>${currency((q.totals?.offer)||0)}</strong></div></div><div class="small" style="margin-top:8px">${items}</div><div class="row" style="margin-top:8px"><button class="ghostlink" data-act="load" data-id="${q.id}">Load</button><button class="ghostlink" data-act="export" data-id="${q.id}">Export JSON</button><button class="ghostlink" data-act="delete" data-id="${q.id}">Delete</button></div>`; box.querySelectorAll('button').forEach(btn=>{ btn.addEventListener('click',async()=>{ const act=btn.getAttribute('data-act'); if(act==='load') await loadQuote(q.id); if(act==='export') exportQuote(q.id,q); if(act==='delete') await deleteQuote(q.id); }); }); list.appendChild(box); });
  }

  async function loadQuote(id){ let q=null; if(supaEnabled){ const sb=await ensureSupabase(); const { data } = await sb.from('quotes').select('*').eq('id',id).maybeSingle(); q=data; } else { q=getQuotesLocal().find(x=>x.id===id); } if(!q) return; plan=(q.items||[]).map(l=>({id:l.id, qty:l.qty, offerUnit:l.offerUnit})); applyBundles(); renderPlan(); }
  async function deleteQuote(id){ if(!confirm('Delete this quote?')) return; if(supaEnabled){ const sb=await ensureSupabase(); await sb.from('quotes').delete().eq('id',id); } else { const qs=getQuotesLocal().filter(x=>x.id!==id); setQuotesLocal(qs); } await renderQuotes(); }
  function exportQuote(id,qObj){ const q=qObj||getQuotesLocal().find(x=>x.id===id); if(!q) return; const blob=new Blob([JSON.stringify(q,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(q.label||'quote')+'.json'; a.click(); }

  // ----- Import CSV/JSON -----
  function splitCsvRow(row){ const out=[]; let cur=''; let inQ=false; for(let i=0;i<row.length;i++){ const c=row[i]; if(c==='"'){ if(inQ && row[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } } else if(c===',' && !inQ){ out.push(cur); cur=''; } else { cur+=c; } } out.push(cur); return out; }
  function slug(s){ return (s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }
  function parseCSV(text){ const lines=text.split(/\r?\n/).filter(x=>x.trim().length>0); const headers=lines[0].split(',').map(h=>h.trim().toLowerCase()); const idx=(h)=>headers.indexOf(h); const arr=[]; for(let i=1;i<lines.length;i++){ const cells=splitCsvRow(lines[i]); const o={ id: slug((cells[idx('id')]||'')||(cells[idx('name')]||'')||('item_'+i)), name:(cells[idx('name')]||'').trim(), category:(cells[idx('category')]||'').trim()||'General', original:Number(cells[idx('original')]||0), advertised: cells[idx('advertised')]? Number(cells[idx('advertised')]): null, floor:Number(cells[idx('floor')]||0), aliases:(cells[idx('aliases')]||'').split('|').map(s=>s.trim()).filter(Boolean), bundles:[] }; const btype=(cells[idx('bundle_type')]||'').trim(); const bmin=Number(cells[idx('bundle_min_qty')]||0); const bunit=cells[idx('bundle_unit_price')]? Number(cells[idx('bundle_unit_price')]): null; const btotal=cells[idx('bundle_total_price')]? Number(cells[idx('bundle_total_price')]): null; if(btype && bmin>0){ if(btype==='unit_price_for_min_qty' && bunit!=null){ o.bundles.push({type:btype,min_qty:bmin,unit_price:bunit}); } if(btype==='total_price_for_min_qty' && btotal!=null){ o.bundles.push({type:btype,min_qty:bmin,total_price:btotal}); } } arr.push(o);} return arr; }
  function handleLoadFile(){ const f=$('#fileInput').files[0]; if(!f){ alert('Choose a CSV or JSON file.'); return; } const reader=new FileReader(); reader.onload=()=>{ try{ if(f.name.toLowerCase().endsWith('.json')){ const data=JSON.parse(reader.result); catalog=Array.isArray(data)?data:(data.items||[]); } else { catalog=parseCSV(reader.result); } if(!Array.isArray(catalog)||catalog.length===0) throw new Error('No items found'); $('#catalogStatus').textContent='Catalog: '+f.name; renderResults(); }catch(err){ alert('Failed to load: '+err.message); } }; reader.readAsText(f); }
  function downloadTemplate(){ const headers=['id','name','category','original','advertised','floor','aliases','bundle_type','bundle_min_qty','bundle_unit_price','bundle_total_price']; const eg=[ ['prp','PRP (Platelet-Rich Plasma)','Skin','10000','7000','5000','PRP','total_price_for_min_qty','3','','21000'], ['pdrn_micro','PDRN Microneedling','Skin','15000','12000','9000','PDRN|Microneedling PDRN','','','',''], ['hydra','Hydrafacial','Facial','10000','7000','5000','Hydra|Hydra Facial','','','',''] ]; const rows=[headers.join(',')].concat(eg.map(r=>r.map(v=>/[\,\n"]/ .test(v)? '"'+String(v).replace(/"/g,'""')+'"':v).join(','))); const blob=new Blob([rows.join('\n')],{type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='revive_catalog_template.csv'; a.click(); }

  // ----- Settings UI -----
  $('#connectSupabase').addEventListener('click', async ()=>{ const url=$('#supabaseUrl').value.trim(); const key=$('#supabaseKey').value.trim(); if(!url||!key){ alert('Enter URL and anon key'); return; } localStorage.setItem('revive_supa_url',url); localStorage.setItem('revive_supa_key',key); try{ await ensureSupabase(); supaEnabled=true; $('#backendLabel').textContent='Supabase'; await supaLoadCatalog(); await renderQuotes(); alert('Connected to Supabase.'); }catch(e){ alert('Connection failed: '+e.message); } });
  $('#disconnectSupabase').addEventListener('click', ()=>{ localStorage.removeItem('revive_supa_url'); localStorage.removeItem('revive_supa_key'); supa=null; supaEnabled=false; $('#backendLabel').textContent='Local'; renderQuotes(); });
  $('#syncCatalogUp').addEventListener('click', async ()=>{ try{ await supaUploadCatalog(); }catch(e){ alert('Upload failed: '+e.message); } });
  $('#syncCatalogDown').addEventListener('click', async ()=>{ try{ await supaLoadCatalog(); }catch(e){ alert('Load failed: '+e.message); } });

  // ----- UI Bindings -----
  $('#search').addEventListener('input', renderResults);
  $('#clearSearch').addEventListener('click',()=>{ $('#search').value=''; renderResults(); });
  $('#loadFile').addEventListener('click', handleLoadFile);
  $('#downloadTemplate').addEventListener('click', downloadTemplate);
  $('#saveQuote').addEventListener('click', saveQuote);
  $('#clearPlan').addEventListener('click',()=>{ if(confirm('Clear current plan?')){ plan=[]; renderPlan(); }});
  $('#printBtn').addEventListener('click',()=> window.print());

  let patientMode=false; function setView(){ document.body.classList.toggle('patient-view',patientMode); $('#toggleViewBtn').textContent = patientMode? 'Switch to Manager View' : 'Switch to Patient View'; }
  $('#toggleViewBtn').addEventListener('click',()=>{ patientMode=!patientMode; setView(); });

  // ----- Init -----
  loadSample(); renderPlan(); renderQuotes(); setView();
  </script>
</body>
</html>
